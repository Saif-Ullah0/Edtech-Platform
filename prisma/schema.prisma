generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Comment {
  id            Int               @id @default(autoincrement())
  content       String
  userId        Int
  noteId        Int?
  videoId       Int?
  parentId      Int?
  isDeleted     Boolean           @default(false)
  isEdited      Boolean           @default(false)
  likesCount    Int               @default(0)
  dislikesCount Int               @default(0)
  repliesCount  Int               @default(0)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  reactions     CommentReaction[]
  note          Note?             @relation(fields: [noteId], references: [id], onDelete: Cascade)
  parent        Comment?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies       Comment[]         @relation("CommentReplies")
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  video         Video?            @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([noteId, createdAt])
  @@index([videoId, createdAt])
  @@index([parentId])
  @@map("comments")
}

model CommentReaction {
  id        Int          @id @default(autoincrement())
  type      ReactionType
  userId    Int
  commentId Int
  createdAt DateTime     @default(now())
  comment   Comment      @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@map("comment_reactions")
}

model DiscountCode {
  id                Int                    @id @default(autoincrement())
  code              String                 @unique
  name              String?
  description       String?
  type              DiscountType           @default(PERCENTAGE)
  value             Float
  maxUses           Int?
  usedCount         Int                    @default(0)
  maxUsesPerUser    Int?                   @default(1)
  startsAt          DateTime?
  expiresAt         DateTime?
  minPurchaseAmount Float?                 @default(0)
  maxDiscountAmount Float?
  applicableToType  DiscountApplicableType @default(ALL)
  applicableToId    Int?
  isActive          Boolean                @default(true)
  isPublic          Boolean                @default(false)
  createdBy         Int?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  orders            Order[]
  creator           User?                  @relation("DiscountCreator", fields: [createdBy], references: [id])
  usages            DiscountUsage[]

  @@map("discount_codes")
}

model DiscountUsage {
  id             Int          @id @default(autoincrement())
  discountCodeId Int
  userId         Int
  orderId        Int?
  bundleId       Int?
  originalAmount Float
  discountAmount Float
  finalAmount    Float
  createdAt      DateTime     @default(now())
  discountCode   DiscountCode @relation(fields: [discountCodeId], references: [id])
  user           User         @relation(fields: [userId], references: [id])

  @@index([discountCodeId, userId])
  @@map("discount_usages")
}

model User {
  id                     Int                @id @default(autoincrement())
  name                   String
  email                  String             @unique
  password               String
  role                   Role               @default(USER)
  createdAt              DateTime           @default(now())
  status                 String             @default("ACTIVE")
  canCreatePublicBundles Boolean            @default(false)
  provider               String?
  providerId             String?
  courses                Enrollment[]
  orders                 Order[]
  bundlePurchases        BundlePurchase[]
  bundles                Bundle[]
  chapterProgress        ChapterProgress[]
  commentReactions       CommentReaction[]
  comments               Comment[]
  createdDiscounts       DiscountCode[]     @relation("DiscountCreator")
  discountUsages         DiscountUsage[]
  moduleEnrollments      ModuleEnrollment[]
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  imageUrl    String?
  createdAt   DateTime @default(now())
  isDeleted   Boolean  @default(false)
  courses     Course[]
}

model Course {
  id                Int                @id @default(autoincrement())
  title             String             @unique
  description       String
  price             Float
  categoryId        Int
  createdAt         DateTime           @default(now())
  imageUrl          String?
  isDeleted         Boolean            @default(false)
  slug              String             @unique
  isPaid            Boolean            @default(false)
  publishStatus     String             @default("DRAFT")
  category          Category           @relation(fields: [categoryId], references: [id])
  enrollments       Enrollment[]
  modules           Module[]
  orderItems        OrderItem[]
  courseBundleItems CourseBundleItem[]
  notes             Note[]
  videos            Video[]
}

model Module {
  id                Int                @id @default(autoincrement())
  title             String
  courseId          Int
  createdAt         DateTime           @default(now())
  orderIndex        Int                @default(0)
  type              ModuleType         @default(TEXT)
  updatedAt         DateTime           @default(now()) @updatedAt
  isFree            Boolean            @default(false)
  isPublished       Boolean            @default(false)
  price             Float              @default(0)
  description       String?
  publishStatus     String             @default("DRAFT")
  slug              String?            @unique
  course            Course             @relation(fields: [courseId], references: [id])
  moduleProgress    ModuleProgress[]
  bundleItems       BundleItem[]
  chapters          Chapter[]
  moduleEnrollments ModuleEnrollment[]
  notes             Note[]
  videos            Video[]
}

model Chapter {
  id              String            @id @default(cuid())
  title           String
  description     String?
  content         String?
  videoUrl        String?
  duration        Int?
  order           Int               @default(0)
  type            ChapterType       @default(TEXT)
  publishStatus   String            @default("DRAFT")
  videoSize       BigInt?
  videoDuration   Int?
  thumbnailUrl    String?
  moduleId        Int
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  chapterProgress ChapterProgress[]
  module          Module            @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  notes           Note[]
  videos          Video[]

  @@map("chapters")
}

model ChapterProgress {
  id                   String    @id @default(cuid())
  userId               Int
  chapterId            String
  isCompleted          Boolean   @default(false)
  watchTime            Int       @default(0)
  completionPercentage Float     @default(0.0)
  completedAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  chapter              Chapter   @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  user                 User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, chapterId])
  @@map("chapter_progress")
}

model ModuleEnrollment {
  id                   Int      @id @default(autoincrement())
  userId               Int
  moduleId             Int
  progress             Float    @default(0)
  completed            Boolean  @default(false)
  paymentTransactionId String?
  purchasePrice        Float
  purchaseDate         DateTime @default(now())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  module               Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@map("module_enrollments")
}

model Bundle {
  id            Int                @id @default(autoincrement())
  name          String
  description   String?
  userId        Int
  totalPrice    Float
  discount      Float              @default(0)
  finalPrice    Float
  isActive      Boolean            @default(true)
  isPurchased   Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  featuredOrder Int?
  isFeatured    Boolean            @default(false)
  isPopular     Boolean            @default(false)
  promotedUntil DateTime?
  revenue       Float              @default(0)
  salesCount    Int                @default(0)
  type          String             @default("MODULE")
  viewCount     Int                @default(0)
  isPublic      Boolean            @default(false)
  moduleItems   BundleItem[]
  purchases     BundlePurchase[]
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseItems   CourseBundleItem[]

  @@map("bundles")
}

model CourseBundleItem {
  id       Int    @id @default(autoincrement())
  bundleId Int
  courseId Int
  bundle   Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([bundleId, courseId])
  @@map("course_bundle_items")
}

model BundleItem {
  id       Int    @id @default(autoincrement())
  bundleId Int
  moduleId Int
  bundle   Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  module   Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([bundleId, moduleId])
  @@map("bundle_items")
}

model BundlePurchase {
  id                   Int      @id @default(autoincrement())
  bundleId             Int
  userId               Int
  paymentTransactionId String?
  purchasePrice        Float
  discount             Float
  finalPrice           Float
  createdAt            DateTime @default(now())
  bundleType           String
  itemCount            Int
  bundle               Bundle   @relation(fields: [bundleId], references: [id])
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("bundle_purchases")
}

model Note {
  id            Int       @id @default(autoincrement())
  title         String
  slug          String    @unique
  description   String?
  content       String?
  fileUrl       String?
  fileName      String?
  fileSize      String?
  fileType      String?
  downloadCount Int       @default(0)
  isPublished   Boolean   @default(false)
  orderIndex    Int       @default(0)
  courseId      Int
  moduleId      Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  isDeleted     Boolean   @default(false)
  chapterId     String?
  comments      Comment[]
  chapter       Chapter?  @relation(fields: [chapterId], references: [id])
  course        Course    @relation(fields: [courseId], references: [id])
  module        Module?   @relation(fields: [moduleId], references: [id])

  @@map("notes")
}

model Video {
  id            Int       @id @default(autoincrement())
  title         String
  slug          String    @unique
  description   String?
  videoUrl      String?
  thumbnailUrl  String?
  fileName      String?
  fileSize      String?
  fileType      String?
  duration      Int?
  quality       String?
  resolution    String?
  uploadStatus  String    @default("PENDING")
  isPublished   Boolean   @default(false)
  orderIndex    Int       @default(0)
  viewCount     Int       @default(0)
  downloadCount Int       @default(0)
  courseId      Int
  moduleId      Int?
  chapterId     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  isDeleted     Boolean   @default(false)
  comments      Comment[]
  chapter       Chapter?  @relation(fields: [chapterId], references: [id])
  course        Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  module        Module?   @relation(fields: [moduleId], references: [id])

  @@map("videos")
}

model Enrollment {
  id                   Int              @id @default(autoincrement())
  userId               Int
  courseId             Int
  createdAt            DateTime         @default(now())
  lastAccessed         DateTime         @default(now()) @updatedAt
  progress             Float?           @default(0.0)
  paymentTransactionId String?
  course               Course           @relation(fields: [courseId], references: [id])
  user                 User             @relation(fields: [userId], references: [id])
  moduleProgress       ModuleProgress[]

  @@unique([userId, courseId])
}

model ModuleProgress {
  id                   Int        @id @default(autoincrement())
  enrollmentId         Int
  moduleId             Int
  isCompleted          Boolean    @default(false)
  watchTime            Int        @default(0)
  completionPercentage Float      @default(0.0)
  completedAt          DateTime?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  enrollment           Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  module               Module     @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, moduleId])
}

model Order {
  id             Int           @id @default(autoincrement())
  userId         Int
  status         OrderStatus   @default(PENDING)
  totalAmount    Float
  createdAt      DateTime      @default(now())
  discountCodeId Int?
  discountCode   DiscountCode? @relation(fields: [discountCodeId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
  items          OrderItem[]
}

model OrderItem {
  id        Int      @id @default(autoincrement())
  orderId   Int
  courseId  Int
  price     Float
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id])
  order     Order    @relation(fields: [orderId], references: [id])
}

enum Role {
  USER
  ADMIN
}

enum OrderStatus {
  PENDING
  COMPLETED
  CANCELED
}

enum ModuleType {
  TEXT
  VIDEO
  PDF
  QUIZ
}

enum ChapterType {
  TEXT
  VIDEO
  PDF
  QUIZ
}

enum ReactionType {
  LIKE
  DISLIKE
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum DiscountApplicableType {
  ALL
  CATEGORY
  COURSE
}
